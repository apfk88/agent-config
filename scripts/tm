#!/usr/bin/env bash
set -euo pipefail

log() { printf '%s\n' "$*"; }
err() { printf 'ERROR: %s\n' "$*" >&2; }
usage() {
  cat <<'USAGE'
Usage:
  tm new [path|url]    Create repo session (agent-0/agent-1/server/bash)
  tm attach            List tmux sessions and attach
  tm help              Show this help
USAGE
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || { err "Missing required command: $1"; exit 1; }
}

repo_root_if_inside() {
  if git rev-parse --show-toplevel >/dev/null 2>&1; then
    git rev-parse --show-toplevel
    return 0
  fi
  return 1
}

is_url_like() {
  case "$1" in
    http://*|https://*|git@*|ssh://*|*github.com*|*gitlab.com*|*bitbucket.org*) return 0 ;;
    */*) return 0 ;;
    *) return 1 ;;
  esac
}

repo_name_from() {
  local input="$1"
  input="${input##*/}"
  input="${input%.git}"
  printf '%s' "$input"
}

clone_repo() {
  local input="$1"
  local url="$input"
  local dest_base="$2"

  if [[ "$input" =~ ^[^/]+/[^/]+$ ]]; then
    url="https://github.com/${input}.git"
  fi

  local name
  name="$(repo_name_from "$input")"

  mkdir -p "$dest_base"
  local dest="${dest_base}/${name}"

  if [ -e "$dest" ]; then
    err "Destination exists: ${dest}"
    exit 1
  fi

  log "Cloning ${url} -> ${dest}"
  git clone "$url" "$dest"
  printf '%s' "$dest"
}

pick_repo() {
  local input="${1:-}"

  if [ -n "$input" ]; then
    if [ -d "$input" ]; then
      (cd "$input" && pwd -P)
      return 0
    fi
    if is_url_like "$input"; then
      local base
      read -r -p "Clone into (default: $HOME/Dev): " base
      base="${base:-$HOME/Dev}"
      clone_repo "$input" "$base"
      return 0
    fi
    err "Not a repo path or URL: $input"
    exit 1
  fi

  local inside=""
  if inside="$(repo_root_if_inside)"; then
    printf '%s' "$inside"
    return 0
  fi

  read -r -p "Repo path or GitHub URL: " input
  if [ -z "$input" ]; then
    err "No input"
    exit 1
  fi

  if [ -d "$input" ]; then
    (cd "$input" && pwd -P)
    return 0
  fi

  if is_url_like "$input"; then
    local base
    read -r -p "Clone into (default: $HOME/Dev): " base
    base="${base:-$HOME/Dev}"
    clone_repo "$input" "$base"
    return 0
  fi

  err "Not a repo path or URL: $input"
  exit 1
}

attach_or_switch() {
  local session="$1"
  if [ -n "${TMUX-}" ]; then
    tmux switch-client -t "$session"
  else
    tmux attach -t "$session"
  fi
}

attach_session() {
  local sessions
  sessions="$(tmux list-sessions -F '#S' 2>/dev/null || true)"
  if [ -z "$sessions" ]; then
    err "No tmux sessions"
    exit 1
  fi

  log "Sessions:"
  local i=1
  while IFS= read -r s; do
    printf '  [%s] %s\n' "$i" "$s"
    i=$((i + 1))
  done <<<"$sessions"

  local choice
  read -r -p "Choose session #: " choice
  if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
    err "Invalid choice"
    exit 1
  fi

  local idx=1
  local target=""
  while IFS= read -r s; do
    if [ "$idx" -eq "$choice" ]; then
      target="$s"
      break
    fi
    idx=$((idx + 1))
  done <<<"$sessions"

  if [ -z "$target" ]; then
    err "Invalid choice"
    exit 1
  fi

  attach_or_switch "$target"
}

new_session() {
  local repo_dir
  repo_dir="$(pick_repo "${1:-}")"

  if ! git -C "$repo_dir" rev-parse --show-toplevel >/dev/null 2>&1; then
    err "Not a git repo: ${repo_dir}"
    exit 1
  fi

  local session
  session="$(basename "$repo_dir")"

  if tmux has-session -t "$session" 2>/dev/null; then
    attach_or_switch "$session"
    return 0
  fi

  tmux new-session -d -s "$session" -c "$repo_dir" -n agent-0
  tmux new-window -t "$session":1 -n agent-1 -c "$repo_dir"
  tmux new-window -t "$session":2 -n server -c "$repo_dir"
  tmux new-window -t "$session":3 -n bash -c "$repo_dir"

  attach_or_switch "$session"
}

main() {
  need_cmd tmux
  need_cmd git

  local cmd="${1:-new}"
  case "$cmd" in
    new)
      shift
      new_session "${1:-}"
      ;;
    attach)
      attach_session
      ;;
    -h|--help|help)
      usage
      ;;
    help)
      usage
      ;;
    *)
      err "Unknown command: $cmd"
      usage
      exit 1
      ;;
  esac
}

main "$@"
